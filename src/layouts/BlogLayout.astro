---
/**
 * BlogLayout - For blog posts
 * Features: Sticky sidebar with TOC, related content, CTA, reading time, author box
 */
import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';

interface Props {
  title: string;
  description: string;
  author?: string;
  pubDate: Date;
  updatedDate?: Date;
  heroImage?: string;
  tags?: string[];
  slug?: string;
  category?: string;
  readingTime?: string;
  relatedPosts?: Array<{ title: string; slug: string; category?: string }>;
}

const {
  title,
  description,
  author = 'Keith Dyer',
  pubDate,
  updatedDate,
  heroImage,
  tags = [],
  slug = '',
  category = 'Marketing',
  readingTime = '5 min read',
  relatedPosts = []
} = Astro.props;

// Breadcrumb items
const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Blog', href: '/blog/' },
  { label: title }
];

// Article schema
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "author": {
    "@type": "Person",
    "name": author,
    "url": "https://lexgro.com/about/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LEXGRO",
    "logo": {
      "@type": "ImageObject",
      "url": "https://lexgro.com/logo.png"
    }
  },
  "datePublished": pubDate.toISOString(),
  ...(updatedDate && { "dateModified": updatedDate.toISOString() }),
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://lexgro.com/blog/${slug}/`
  }
};

// Format date
function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}
---

<BaseLayout title={title} description={description} image={`/og/blog/${slug}.png`}>
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

  <article class="blog-article">
    <!-- Header -->
    <header class="blog-header">
      <div class="container">
        <Breadcrumbs items={breadcrumbItems} />

        <div class="header-content">
          <span class="category-label">{category}</span>
          <h1>{title}</h1>
          <p class="description">{description}</p>

          <div class="meta-row">
            <div class="author-meta">
              <img
                src="/images/keith-dyer.jpg"
                alt={author}
                class="author-avatar"
                width="48"
                height="48"
                onerror="this.style.display='none'"
              />
              <div class="author-details">
                <span class="author-name">{author}</span>
                <span class="author-title">Fractional CMO</span>
              </div>
            </div>

            <div class="post-meta">
              <time datetime={pubDate.toISOString()}>
                {formatDate(pubDate)}
              </time>
              <span class="separator">·</span>
              <span class="reading-time">{readingTime}</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Reading Progress Bar -->
    <div class="progress-bar" id="progress-bar"></div>

    <!-- Main Content Grid -->
    <div class="blog-grid container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-inner">
          <!-- Table of Contents -->
          <nav class="toc-section">
            <h4 class="sidebar-title">In This Article</h4>
            <div id="toc-links" class="toc-links">
              <!-- Populated by JS -->
            </div>
          </nav>

          <!-- CTA Card -->
          <div class="cta-card">
            <span class="cta-eyebrow">Free Strategy Session</span>
            <h4>Ready to Grow Your Firm?</h4>
            <p>Get a personalized marketing roadmap for your practice.</p>
            <a href="https://calendly.com/lexgro/strategy-session" class="btn btn-primary btn-sm">
              Book a Call
            </a>
          </div>

          <!-- Related Articles -->
          {relatedPosts.length > 0 && (
            <div class="related-section">
              <h4 class="sidebar-title">Related Articles</h4>
              <ul class="related-list">
                {relatedPosts.slice(0, 3).map(post => (
                  <li>
                    <a href={`/blog/${post.slug}/`}>
                      <span class="related-category">{post.category || 'Blog'}</span>
                      <span class="related-title">{post.title}</span>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          )}

          <!-- Quick Links -->
          <div class="quick-links">
            <h4 class="sidebar-title">Explore More</h4>
            <ul>
              <li><a href="/guide/law-firm-marketing/">Marketing Guide</a></li>
              <li><a href="/guide/law-firm-seo/">SEO Guide</a></li>
              <li><a href="/services/fractional-cmo/">CMO Services</a></li>
              <li><a href="/podcast/">Podcast</a></li>
            </ul>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <div class="main-content">
        <div class="blog-body prose" id="blog-content">
          <slot />
        </div>

        <!-- Tags -->
        {tags.length > 0 && (
          <div class="tags-section">
            <span class="tags-label">Topics:</span>
            {tags.map(tag => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        )}

        <!-- Author Box -->
        <div class="author-box">
          <img
            src="/images/keith-dyer.jpg"
            alt={author}
            class="author-image"
            width="80"
            height="80"
            onerror="this.style.display='none'"
          />
          <div class="author-content">
            <span class="author-label">Written by</span>
            <h4 class="author-name">{author}</h4>
            <p class="author-bio">
              Keith Dyer is a fractional CMO who helps law firms build predictable,
              sustainable growth through strategic marketing. With over 15 years in
              legal marketing, he's worked with firms across all practice areas.
            </p>
            <a href="/about/" class="author-link">Learn more about Keith →</a>
          </div>
        </div>

        <!-- Bottom CTA -->
        <div class="bottom-cta">
          <div class="cta-content">
            <h3>Want to Implement These Strategies?</h3>
            <p>
              Reading is great, but results come from action. Let's talk about
              how to put these insights to work for your firm.
            </p>
            <a href="https://calendly.com/lexgro/strategy-session" class="btn btn-primary btn-lg">
              Schedule a Strategy Call
            </a>
          </div>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

<style>
  /* Header */
  .blog-header {
    background: linear-gradient(180deg, var(--color-bg-light) 0%, white 100%);
    padding: 3rem 0 2.5rem;
  }

  .header-content {
    max-width: 800px;
  }

  .category-label {
    display: inline-block;
    background: var(--color-primary);
    color: white;
    font-size: 0.6875rem;
    font-weight: 700;
    padding: 0.375rem 0.875rem;
    border-radius: 100px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 1rem;
  }

  .blog-header h1 {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    line-height: 1.2;
    margin-bottom: 1rem;
    color: var(--color-text-dark);
  }

  .description {
    font-size: 1.125rem;
    color: var(--color-text-muted);
    line-height: 1.6;
    margin-bottom: 1.5rem;
  }

  .meta-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }

  .author-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .author-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    background: var(--color-bg-light);
  }

  .author-details {
    display: flex;
    flex-direction: column;
  }

  .author-details .author-name {
    font-weight: 600;
    color: var(--color-text-dark);
  }

  .author-details .author-title {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  .separator {
    opacity: 0.5;
  }

  .reading-time {
    color: var(--color-primary);
    font-weight: 500;
  }

  /* Progress Bar */
  .progress-bar {
    position: fixed;
    top: 72px;
    left: 0;
    height: 3px;
    background: var(--color-primary);
    width: 0%;
    z-index: 100;
    transition: width 0.1s ease;
  }

  /* Main Grid */
  .blog-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 3rem;
    padding-top: 3rem;
    padding-bottom: 4rem;
  }

  @media (min-width: 1024px) {
    .blog-grid {
      grid-template-columns: 280px 1fr;
      gap: 4rem;
    }
  }

  /* Sidebar */
  .sidebar {
    order: 2;
  }

  @media (min-width: 1024px) {
    .sidebar {
      order: 1;
    }
  }

  .sidebar-inner {
    position: sticky;
    top: 100px;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .sidebar-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
    margin-bottom: 0.75rem;
  }

  /* TOC */
  .toc-section {
    padding: 1.25rem;
    background: var(--color-bg-light);
    border-radius: 12px;
  }

  .toc-links {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .toc-links :global(a) {
    display: block;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-decoration: none;
    border-radius: 6px;
    transition: all 0.2s ease;
    line-height: 1.4;
  }

  .toc-links :global(a:hover) {
    background: white;
    color: var(--color-primary);
  }

  .toc-links :global(a.active) {
    background: white;
    color: var(--color-primary);
    font-weight: 500;
  }

  .toc-links :global(a.toc-link--sub) {
    padding-left: 1.5rem;
    font-size: 0.8125rem;
  }

  /* CTA Card */
  .cta-card {
    background: var(--color-bg-dark);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    text-align: center;
  }

  .cta-eyebrow {
    display: block;
    font-size: 0.6875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-mint);
    margin-bottom: 0.5rem;
  }

  .cta-card h4 {
    font-size: 1.125rem;
    margin-bottom: 0.5rem;
  }

  .cta-card p {
    font-size: 0.875rem;
    opacity: 0.8;
    margin-bottom: 1rem;
    line-height: 1.5;
  }

  .cta-card .btn {
    width: 100%;
  }

  /* Related Articles */
  .related-section {
    padding: 1.25rem;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: 12px;
  }

  .related-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .related-list a {
    display: block;
    text-decoration: none;
    padding: 0.75rem;
    background: var(--color-bg-light);
    border-radius: 8px;
    transition: all 0.2s ease;
  }

  .related-list a:hover {
    background: var(--color-primary);
    color: white;
  }

  .related-list a:hover .related-category {
    color: var(--color-mint);
  }

  .related-list a:hover .related-title {
    color: white;
  }

  .related-category {
    display: block;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-primary);
    margin-bottom: 0.25rem;
  }

  .related-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-dark);
    line-height: 1.4;
  }

  /* Quick Links */
  .quick-links ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .quick-links a {
    display: block;
    padding: 0.5rem 0;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-decoration: none;
    border-bottom: 1px solid var(--color-border);
    transition: color 0.2s ease;
  }

  .quick-links li:last-child a {
    border-bottom: none;
  }

  .quick-links a:hover {
    color: var(--color-primary);
  }

  /* Main Content */
  .main-content {
    order: 1;
    max-width: 720px;
  }

  @media (min-width: 1024px) {
    .main-content {
      order: 2;
    }
  }

  .blog-body {
    line-height: 1.75;
  }

  /* Tags */
  .tags-section {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    padding: 1.5rem 0;
    margin-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .tags-label {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-text-muted);
  }

  .tag {
    background: var(--color-bg-light);
    color: var(--color-text-muted);
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.375rem 0.75rem;
    border-radius: 100px;
  }

  /* Author Box */
  .author-box {
    display: flex;
    gap: 1.5rem;
    padding: 2rem;
    background: var(--color-bg-light);
    border-radius: 16px;
    margin-top: 2rem;
  }

  @media (max-width: 600px) {
    .author-box {
      flex-direction: column;
      text-align: center;
    }
  }

  .author-image {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
    background: white;
  }

  .author-content {
    flex: 1;
  }

  .author-label {
    font-size: 0.6875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
  }

  .author-content .author-name {
    font-size: 1.125rem;
    font-weight: 700;
    margin: 0.25rem 0 0.5rem;
    color: var(--color-text-dark);
  }

  .author-bio {
    font-size: 0.9375rem;
    color: var(--color-text-muted);
    line-height: 1.6;
    margin-bottom: 0.75rem;
  }

  .author-link {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-primary);
    text-decoration: none;
  }

  .author-link:hover {
    text-decoration: underline;
  }

  /* Bottom CTA */
  .bottom-cta {
    margin-top: 3rem;
    padding: 3rem;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-teal) 100%);
    border-radius: 20px;
    text-align: center;
  }

  .cta-content {
    max-width: 500px;
    margin: 0 auto;
  }

  .bottom-cta h3 {
    font-size: 1.5rem;
    color: white;
    margin-bottom: 0.75rem;
  }

  .bottom-cta p {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 1.5rem;
    line-height: 1.6;
  }

  .bottom-cta .btn {
    background: white;
    color: var(--color-primary);
  }

  .bottom-cta .btn:hover {
    background: rgba(255, 255, 255, 0.9);
  }
</style>

<script>
  // Generate TOC from headings
  document.addEventListener('DOMContentLoaded', () => {
    const tocContainer = document.getElementById('toc-links');
    const content = document.getElementById('blog-content');
    const headings = content?.querySelectorAll('h2, h3');

    if (tocContainer && headings && headings.length > 0) {
      headings.forEach((heading, index) => {
        // Generate ID if not present
        if (!heading.id) {
          heading.id = heading.textContent
            ?.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/(^-|-$)/g, '') || `section-${index}`;
        }

        const link = document.createElement('a');
        link.href = `#${heading.id}`;
        link.textContent = heading.textContent;
        link.className = heading.tagName === 'H3' ? 'toc-link toc-link--sub' : 'toc-link';
        tocContainer.appendChild(link);
      });

      // Highlight active section on scroll
      const observerOptions = {
        rootMargin: '-100px 0px -70% 0px',
        threshold: 0
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const id = entry.target.getAttribute('id');
          const tocLink = tocContainer.querySelector(`a[href="#${id}"]`);

          if (entry.isIntersecting) {
            tocContainer.querySelectorAll('a').forEach(a => a.classList.remove('active'));
            tocLink?.classList.add('active');
          }
        });
      }, observerOptions);

      headings.forEach(heading => observer.observe(heading));
    }

    // Reading progress bar
    const progressBar = document.getElementById('progress-bar');
    const article = document.querySelector('.blog-article');

    if (progressBar && article) {
      window.addEventListener('scroll', () => {
        const articleTop = article.offsetTop;
        const articleHeight = article.offsetHeight;
        const windowHeight = window.innerHeight;
        const scrollY = window.scrollY;

        const progress = Math.min(
          Math.max((scrollY - articleTop + windowHeight * 0.3) / (articleHeight - windowHeight * 0.5), 0),
          1
        );

        progressBar.style.width = `${progress * 100}%`;
      });
    }
  });
</script>
